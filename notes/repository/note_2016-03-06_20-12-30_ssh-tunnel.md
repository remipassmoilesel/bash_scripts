# Utiliser des tunnels SSH

## Types de tunnels

### -D

Tunnel Socks 5 dynamique. Spécifier le port local, le port distant sera dynamique en fonctions des applications utilisées 
par le tunnel.

### -L

Publier un port local qui dirige le traffic vers un port distant.

### -R

Publier un port distant qui dirige le traffic vers un port local. Peut nécéssiter d'autres options.

## Avec un navigateur et un SOCKS

Remarque: les ports 80 et 443 sont souvent moins restreints.

Paramétrer le serveur OpenSSH pour qu'il écoute 443

	$ vim /etc/ssh/sshd_config 
	# Ajouter: 
	Port 443

Lancer une connexion: 
    
	$ ssh -D portLocal user@server -p portDistantSsh
	$ ssh -D 1234 remipassmoilesel@serveur -p 443

Paramétrer Firefox
    
	Préférences / Avancé / Réseaux / Connexion > Paramètres
	Configuration manuelle du proxy
	Hote SOCKS: 127.0.0.1:1234

Ou avec Chromium:

	$ chromium-browser --proxy-server="socks5://localhost:1234"

Source: http://www.bidouille.org/prog/sshproxy

Pour utiliser Corkscrew et wrapper le SSH dans du HTTPS:
https://memo-linux.com/ssh-acces-travail-maison/

## Avec IRSSI 

Ouvrir un tunnel SSH:

        $ ssh -L 6667:irc_server:6667 user@remote.host.com

Ouvrir IRSSI:

        $ irssi -c localhost

Source: https://ninjaverification.wordpress.com/2008/04/11/irssi-through-an-ssh-tunnel/

## Avec SSH

	$ ssh -L 2000:localhost:22 user@remote-host
	
	2000: port local
	22: port distant

	$ ssh -p 2000 localhost

## Utiliser autossh

Exemples:

    # Faire suivre un port local (5669) sur une machine distante (6669)
    $ autossh -f -N -M $AUTOSSH_MPORT_LOCAL -R 6669:localhost:5669 ssh-tunnel.poller

    # Faire suivre un port distant (22) sur un port local (1022)
    $ autossh -f -N -M $AUTOSSH_MPORT_REMOTE -L 1022:localhost:22 ssh-tunnel.poller


Détail:

	  -M 2000 port de monitoring, utilisé pour détecter les problèmes de connexion et reconnecter
	  Les ports N et N+1 doivent être libres.

## Utiliser un rebond

    $ vim ~/.ssh/config

    Host ssh-tunnel.bastion.10.0.0.100
        User user
        IdentityFile ~/.ssh/id_rsa
        HostName 10.0.0.100
        Port 22

    Host ssh-tunnel.poller.172.16.0.50
        User centreon
        IdentityFile ~/.ssh/id_rsa
        Port 22
        HostKeyAlias 172.16.0.50
        ProxyCommand ssh ssh-tunnel.bastion.10.0.0.100 nc -q0 172.16.0.50 22
    
    Host poller-preprod-2.ssh
        User centreon
        Port 1101
        IdentityFile ~/.ssh/id_rsa


